# ./scripts/k3s.downloader.all.sh
# ./scripts/k3s.setup.master.sh
# ./scripts/k3s.setup.worker.sh
# ./scripts/kubectl.installer.all.sh
# ./scripts/firewall.disable.all.sh

PROVIDER = "virtualbox"
Vagrant.configure("2") do |config|

  config.vm.box = "generic/centos8"
  config.vm.box_url = "https://app.vagrantup.com/generic/boxes/centos8"

  config.vm.synced_folder ".", "/vagrant"

  config.vm.provider PROVIDER do |v|
    v.gui = true
    v.memory = "1024"
    v.cpus = 1
  end

  config.vm.provision :shell,
    path: "./scripts/k3s.installer.all.sh",
    run: "always"

  config.vm.provision :shell,
    path: "./scripts/firewall.disable.all.sh",
    run: "always"

  config.vm.provision :shell,
    path: "./scripts/kubectl.installer.all.sh",
    run: "always"

  MASTER_NAME = "mamauraiServer"
  MASTER_IP = "192.168.56.110"
  config.vm.define MASTER_NAME do |m|
    m.vm.hostname = MASTER_NAME
    m.vm.network "private_network", ip: MASTER_IP
    m.vm.provision :shell,
      path: "./scripts/k3s.setup.master.sh",
      run: "always",
      args: [MASTER_IP, MASTER_NAME]
    m.vm.provider PROVIDER do |v|
      v.name = MASTER_NAME
    end
  end

  WORKER_NAME = "mamauraiServerWorker"
  WORKER_IP = "192.168.56.111"
  config.vm.define WORKER_NAME do |m|
    m.vm.hostname = WORKER_NAME
    m.vm.network "private_network", ip: WORKER_IP 
    m.vm.provision :shell,
      path: "./scripts/k3s.setup.worker.sh",
      run: "always",
      args: [WORKER_IP, MASTER_IP, WORKER_NAME]
    m.vm.provider PROVIDER do |v|
      v.name = WORKER_NAME
    end
  end

  config.trigger.after :up do |t|
    t.name = "Finished Message"
    t.info = "Machine is up!"
  end

  # Remove the agent token when the VM are destroyed
  config.trigger.before :destroy do |t|
    t.info = "remove the agent token"
    t.run = {inline: "rm -rf .agent-token .log"}
    t.only_on = MASTER_NAME
  end
  
  config.trigger.before :up do |t|
    t.info = "create .log directory"
    t.run = {inline: "mkdir -p ./.log"}
    t.only_on = MASTER_NAME
  end
end
  
